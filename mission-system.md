# 🎯 미션 시스템 가이드

숲(SOOP) 플랫폼의 도전미션과 대결미션을 완벽하게 지원하는 DonationAPI의 미션 시스템을 상세히 설명합니다.

> ⚠️ **중요**: 미션 시스템은 숲(SOOP) 플랫폼 전용 기능입니다. 치지직은 공식 API 사용으로 미션 후원을 지원하지 않습니다.

## 📋 목차

- [미션 시스템 개요](#-미션-시스템-개요)
- [도전미션](#-도전미션)
- [대결미션](#-대결미션)
- [미션 설정 시스템](#-미션-설정-시스템)
- [실제 사용 예제](#-실제-사용-예제)
- [고급 설정](#-고급-설정)
- [문제해결](#-문제해결)

## 🎯 미션 시스템 개요

### 미션이란?
숲 플랫폼에서 제공하는 특별한 후원 시스템으로, 정확한 금액을 맞춰야 성공하는 게임 요소입니다.

### 지원하는 미션 타입
- **도전미션**: 개별 시청자가 정확한 금액을 맞춰야 하는 미션
- **대결미션**: 여러 시청자가 참여하여 총 금액을 맞춰야 하는 미션

### 미션의 특징
- 정확한 금액 매칭이 핵심
- 초과/부족 금액에 대한 유연한 처리
- 실시간 피드백 및 로깅

## 🎮 도전미션

### 도전미션이란?
개별 시청자가 설정된 목표 금액을 정확히 맞춰야 하는 미션입니다.

### 동작 방식
```
목표 금액: 1234원
시청자 후원: 1234원 → 성공!
시청자 후원: 1200원 → 실패 (부족)
시청자 후원: 1300원 → 실패 (초과)
```

### 기본 설정
```bash
# 정확한 금액 이벤트 설정
/후원관리 이벤트설정 공통 1234 스트리머 메시지 title:&6도전미션 성공!\nsubtitle:&e정확히 맞추셨습니다!
/후원관리 이벤트설정 공통 1234 스트리머 명령어 CONSOLE:/give %player% diamond 1

# 미션 실패 시 기본 이벤트 (무한 이벤트)
/후원관리 이벤트설정 공통 무한 전체 메시지 &7%donator_name%님 후원 감사합니다!
```

### 오차 범위 허용 설정
```bash
# 5% 오차 범위 허용 (1234원 ± 5%)
/후원관리 실행설정 down_tolerance_enabled true
/후원관리 실행설정 down_tolerance_type percent
/후원관리 실행설정 down_tolerance_percent 5

/후원관리 실행설정 up_tolerance_enabled true
/후원관리 실행설정 up_tolerance_type percent
/후원관리 실행설정 up_tolerance_percent 5
```

### 도전미션 예시 시나리오
```
목표: 1234원 (±5% 허용)
허용 범위: 1172원 ~ 1296원

후원 1234원 → 정확한 금액 이벤트 실행
후원 1200원 → 5% 하향 오차 범위 이벤트 실행
후원 1250원 → 5% 상향 오차 범위 이벤트 실행
후원 1100원 → 오차 범위 벗어남, 무한 이벤트 실행
```

## ⚔️ 대결미션

### 대결미션이란?
여러 시청자가 함께 참여하여 총 후원 금액을 목표에 맞춰야 하는 미션입니다.

### 동작 방식
```
목표 금액: 10000원
시청자A: 3000원
시청자B: 2000원  
시청자C: 5000원
총합: 10000원 → 성공!
```

### 대결미션 처리 방식
DonationAPI는 각 개별 후원을 받을 때마다 이벤트를 실행합니다:

```bash
# 목표: 10000원 이벤트 설정
/후원관리 이벤트설정 공통 10000 전체 메시지 &6&l대결미션 성공!
/후원관리 이벤트설정 공통 10000 전체 명령어 CONSOLE:/give @a emerald 1

# 개별 후원 이벤트도 함께 실행
/후원관리 이벤트설정 공통 무한 전체 메시지 &a%donator_name%님 %amount%원 참여 감사합니다!
```

### 대결미션에서의 우선순위
```
1. 개별 후원 금액의 정확한 이벤트 (있는 경우)
2. 개별 후원 금액의 범위 이벤트 (있는 경우)  
3. 목표 금액 달성 시 이벤트 (대결미션 성공)
4. 무한 이벤트 (기본 참여 감사)
```

## ⚙️ 미션 설정 시스템

### 정확한 매칭 설정

**정확한 금액만 허용**
```bash
# 오차 범위 완전 무시
/후원관리 실행설정 exact_match_only true

# 정확한 금액이 있으면 우선 실행
/후원관리 실행설정 exact_match_priority true
```

**설정 비교:**
```yaml
exact_match_only: true
- 1234원 이벤트가 있고, 1200원 후원 시
- → 오차 범위 무시, 무한 이벤트만 실행

exact_match_priority: true  
- 1234원 이벤트가 있고, 1200원 후원 시
- → 정확한 금액 우선, 오차 범위 이벤트 무시
```

### 하향 오차 범위 (부족한 금액)

**퍼센트 기반 오차**
```bash
# 목표 금액보다 5% 부족까지 허용
/후원관리 실행설정 down_tolerance_enabled true
/후원관리 실행설정 down_tolerance_type percent
/후원관리 실행설정 down_tolerance_percent 5

# 예시: 1000원 목표 → 950원 이상부터 성공
```

**고정 금액 기반 오차**
```bash
# 목표 금액보다 100원 부족까지 허용
/후원관리 실행설정 down_tolerance_type amount
/후원관리 실행설정 down_tolerance_amount 100

# 예시: 1000원 목표 → 900원 이상부터 성공
```

**비율 실행 (중요!)**
```bash
# 부족한 금액을 비율로 계산하여 여러 번 실행
/후원관리 실행설정 down_ratio_execution true

# 예시:
# 목표: 1000원 이벤트
# 후원: 2500원
# → 1000원 이벤트를 2번 실행 (2500 ÷ 1000 = 2)
```

### 상향 오차 범위 (초과한 금액)

**퍼센트 기반 오차**
```bash
# 목표 금액보다 10% 초과까지 허용
/후원관리 실행설정 up_tolerance_enabled true
/후원관리 실행설정 up_tolerance_type percent
/후원관리 실행설정 up_tolerance_percent 10

# 예시: 1000원 목표 → 1100원까지 성공
```

**다중 실행**
```bash
# 범위 내 여러 이벤트 동시 실행
/후원관리 실행설정 multiple_execution true
/후원관리 실행설정 max_events 3

# 예시: 1050원 후원 시
# → 1000원, 1020원, 1100원 이벤트가 모두 범위 내라면 모두 실행
```

### 검색 설정

**검색 방향**
```bash
# 위쪽만 검색 (초과 금액만)
/후원관리 실행설정 search_direction up

# 아래쪽만 검색 (부족 금액만)  
/후원관리 실행설정 search_direction down

# 양방향 검색 (기본값)
/후원관리 실행설정 search_direction both
```

**가장 가까운 것 우선**
```bash
# 가장 가까운 금액의 이벤트만 실행
/후원관리 실행설정 closest_first true

# 예시: 1200원 후원, 1000원과 1500원 이벤트 존재
# → 1000원 이벤트만 실행 (200원 차이 < 300원 차이)
```

## 💡 실제 사용 예제

### 도전미션 완벽 설정

**1단계: 목표 금액 이벤트 설정**
```bash
# 정확한 금액 (1234원)
/후원관리 이벤트설정 공통 1234 전체 메시지 title:&6&l🎯 도전미션 성공!\nsubtitle:&e%donator_name%님이 정확히 맞추셨습니다!
/후원관리 이벤트설정 공통 1234 스트리머 명령어 CONSOLE:/give %player% diamond 3
/후원관리 이벤트설정 공통 1234 전체 명령어 CONSOLE:/give @a emerald 1
```

**2단계: 오차 범위 설정**
```bash
# ±3% 오차 허용
/후원관리 실행설정 exact_match_priority true
/후원관리 실행설정 down_tolerance_enabled true
/후원관리 실행설정 down_tolerance_type percent
/후원관리 실행설정 down_tolerance_percent 3
/후원관리 실행설정 up_tolerance_enabled true
/후원관리 실행설정 up_tolerance_type percent  
/후원관리 실행설정 up_tolerance_percent 3
```

**3단계: 오차 범위 이벤트 설정**
```bash
# 오차 범위 내 성공 이벤트
/후원관리 이벤트설정 공통 1197~1271 전체 메시지 title:&a거의 성공!\nsubtitle:&e%donator_name%님 아깝습니다!
/후원관리 이벤트설정 공통 1197~1271 스트리머 명령어 CONSOLE:/give %player% gold_ingot 1
```

**4단계: 실패 시 기본 이벤트**
```bash
# 완전히 벗어난 경우
/후원관리 이벤트설정 공통 무한 전체 메시지 &7%donator_name%님 도전 감사합니다! 다시 도전해보세요!
```

### 대결미션 설정

**1단계: 목표 금액 설정**
```bash
# 대결미션 목표: 50000원
/후원관리 이벤트설정 공통 50000 전체 메시지 title:&4&l⚔️ 대결미션 성공!\nsubtitle:&6모든 참여자 승리!
/후원관리 이벤트설정 공통 50000 전체 명령어 CONSOLE:/give @a diamond 5
/후원관리 이벤트설정 공통 50000 전체 명령어 CONSOLE:/weather clear
/후원관리 이벤트설정 공통 50000 전체 명령어 CONSOLE:/time set day
```

**2단계: 개별 참여 이벤트**
```bash
# 각 참여자에 대한 감사 메시지
/후원관리 이벤트설정 공통 무한 전체 메시지 &b⚔️ %donator_name%님이 대결미션에 %amount%원으로 참여하셨습니다!
```

**3단계: 특별 금액 이벤트**
```bash
# 큰 금액 기여자 특별 대우
/후원관리 이벤트설정 공통 10000~50000 전체 메시지 &d💎 %donator_name%님의 대형 기여! %amount%원!
/후원관리 이벤트설정 공통 10000~50000 스트리머 명령어 CONSOLE:/give %player% netherite_ingot 1
```

### 복합 미션 설정

**다단계 도전미션**
```bash
# 1단계: 1111원
/후원관리 이벤트설정 공통 1111 전체 메시지 &a1단계 클리어! %donator_name%님!
/후원관리 이벤트설정 공통 1111 스트리머 명령어 CONSOLE:/give %player% iron_ingot 5

# 2단계: 2222원
/후원관리 이벤트설정 공통 2222 전체 메시지 &62단계 클리어! %donator_name%님!
/후원관리 이벤트설정 공통 2222 스트리머 명령어 CONSOLE:/give %player% gold_ingot 3

# 3단계: 3333원 (최종)
/후원관리 이벤트설정 공통 3333 전체 메시지 title:&4&l🏆 최종 단계 클리어!\nsubtitle:&6%donator_name%님 완주 축하드립니다!
/후원관리 이벤트설정 공통 3333 스트리머 명령어 CONSOLE:/give %player% diamond 10
/후원관리 이벤트설정 공통 3333 전체 명령어 CONSOLE:/give @a emerald 3
```

## 🔧 고급 설정

### 미션 로깅 설정

**기본 로깅 활성화**
```bash
# 미션 결과 로깅
/후원관리 실행설정 mission_logging true

# 상세 로깅 (디버깅용)
/후원관리 실행설정 detail_logging true
```

**로그 예시:**
```
[DonationAPI] 미션 결과: 정확한 금액 이벤트 실행 (목표: 1234, 실제: 1234)
[DonationAPI] 미션 결과: 하향 오차 범위 이벤트 실행 (목표: 1234, 실제: 1200)
[DonationAPI] 미션 결과: 비율 실행 (목표: 1000, 실제: 2500, 실행횟수: 2)
```

### 성능 최적화

**중복 제거**
```bash
# 동일한 이벤트 중복 실행 방지
/후원관리 실행설정 remove_duplicates true
```

**최대 실행 횟수 제한**
```bash
# 한 번에 최대 5개 이벤트만 실행
/후원관리 실행설정 max_events 5
```

### 플랫폼별 미션 설정

**숲 전용 미션**
```bash
# 숲에서만 동작하는 특별 미션
/후원관리 이벤트설정 숲 7777 전체 메시지 &6🌲 숲 특별 미션 성공! %donator_name%님!
/후원관리 이벤트설정 숲 7777 스트리머 명령어 CONSOLE:/give %player% oak_sapling 77
```

## 🛠️ 문제해결

### 자주 발생하는 문제

**Q: 정확한 금액을 후원했는데 이벤트가 실행되지 않아요**
```bash
# 해결책:
1. 이벤트가 올바르게 설정되었는지 확인
/후원관리 목록 공통

2. 미션 시스템이 활성화되어 있는지 확인
config.yml에서 mission.enabled: true

3. 테스트 실행으로 확인
/후원관리 테스트 공통 1234
```

**Q: 오차 범위 설정이 작동하지 않아요**
```bash
# 해결책:
1. exact_match_only가 true로 설정되어 있는지 확인
/후원관리 실행설정 exact_match_only false

2. 오차 범위가 올바르게 설정되어 있는지 확인
/후원관리 실행설정 목록

3. 디버그 로깅으로 확인
/후원관리 실행설정 detail_logging true
```

**Q: 비율 실행이 너무 많이 되어요**
```bash
# 해결책:
1. 최대 실행 횟수 제한
/후원관리 실행설정 max_events 3

2. 비율 실행 비활성화
/후원관리 실행설정 down_ratio_execution false

3. 더 높은 금액 이벤트 설정으로 비율 실행 방지
```

### 미션 테스트 방법

**단계별 테스트**
```bash
# 1. 정확한 금액 테스트
/후원관리 테스트 공통 1234

# 2. 하향 오차 테스트  
/후원관리 테스트 공통 1200

# 3. 상향 오차 테스트
/후원관리 테스트 공통 1270

# 4. 완전 실패 테스트
/후원관리 테스트 공통 500
```

**로그 확인**
```bash
# 디버그 로깅 활성화 후 테스트
/후원관리 실행설정 detail_logging true
/후원관리 테스트 공통 1234

# 콘솔에서 로그 확인
[DonationAPI] 미션 결과: 정확한 금액 이벤트 실행...
```

### 설정 백업 및 복원

**현재 설정 확인**
```bash
# 모든 미션 설정 확인
/후원관리 실행설정 목록

# 특정 대상의 이벤트 확인
/후원관리 목록 공통
```

**설정 초기화**
```yaml
# config.yml에서 기본값으로 복원
mission:
  enabled: true
  exact_match:
    only: false
    priority: true
  down_tolerance:
    enabled: false
    type: "percent"
    percent: 5.0
    amount: 100
    ratio_execution: false
  up_tolerance:
    enabled: false
    type: "percent"
    percent: 5.0
    amount: 100
    multiple_execution: false
    max_events: 3
```

---

**💡 미션 성공의 핵심:**
- 명확한 목표 금액 설정
- 적절한 오차 범위 허용
- 단계별 테스트를 통한 검증
- 참여자들에게 명확한 규칙 안내 